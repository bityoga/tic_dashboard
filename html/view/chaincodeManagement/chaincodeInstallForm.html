<link rel="stylesheet" href="css/multistepform.css" />
<div
  class="d-flex align-items-center justify-content-center pb-5 mt-3"
  style="height: inherit;"
>
  <div class="col-12 col-sm-12 col-md-7 col-lg-6 col-xl-4">
    <div class="card text-center">
      <div class="card-header p-4 bg-secondary text-white">
        <h2>
          <i class="fa fa-desktop" aria-hidden="true"></i> Install Chaincode
        </h2>
      </div>
      <div class="card-body">
        <form id="msform">
          <!-- progressbar -->
          <ul id="progressbar">
            <li class="active" id="account"><strong>1) Select</strong></li>
            <li id="personal"><strong>2) Install</strong></li>
            <li id="payment"><strong>3) Instantiate</strong></li>
            <li id="payment"><strong>Finish</strong></li>
          </ul>
          <div class="progress">
            <div
              class="progress-bar progress-bar-striped progress-bar-animated"
              role="progressbar"
              aria-valuemin="0"
              aria-valuemax="100"
            ></div>
          </div>
          <br />
          <!-- fieldsets -->

          <fieldset id="smart-contract-src-code-fieldset">
            <div class="form-card">
              <div class="row">
                <div class="col-7">
                  <h2 class="fs-title">Upload Src Code (Zip file)</h2>
                </div>
                <div class="col-5">
                  <h2 class="steps">Step 1 - 3</h2>
                </div>
              </div>

              <div id="select-upload-method-radio-button-div">
                <label class="fieldlabels">Select an Upload Method :</label>
                <br />

                <select
                  name="fileUploadTypeSelection"
                  name="fileUploadTypeSelection"
                  class="form-select"
                  aria-label="Select an Upload Method :"
                >
                  <option selected value="fileUpload">File Upload</option>
                  <option value="github">From Git</option>
                </select>
              </div>

              <div id="github-repo-selector-div">
                <label class="fieldlabels">Github Repo Url: *</label>
                <input
                  type="text"
                  name="githubUrl"
                  id="githubUrl"
                  placeholder="Github Repository Url"
                />

                <label class="fieldlabels"
                  >Specific branch (Other than master) *</label
                >
                <input
                  type="text"
                  name="githubUrlBranch"
                  id="githubUrlBranch"
                  placeholder="Github Repository Branch"
                />

                <label class="fieldlabels"
                  >Rename Smart Contract(Optional): *</label
                >
                <input
                  type="text"
                  name="githubUrlRename"
                  id="githubUrlRename"
                  placeholder="New Name for chaincode"
                />

                <div id="github-repo-selector-radio-button-div">
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="githubRepoType"
                      id="radio-button-public-repo"
                      value="public"
                      checked
                    />
                    <label class="form-check-label" for="inlineRadio1">
                      Public Repository</label
                    >
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="githubRepoType"
                      id="radio-button-private-repo"
                      value="private"
                    />
                    <label class="form-check-label" for="inlineRadio2">
                      Private Repostory (Requires Github Authentication
                      Credentials)</label
                    >
                  </div>
                </div>

                <div id="github-private-repo-auth-credential-info-div">
                  <label class="fieldlabels"
                    >Your Github Access Token: (<a
                      href="https://github.com/settings/tokens"
                      >Visit to generate a access token</a
                    >
                    )*</label
                  >
                  <input
                    type="password"
                    name="githubAccessToken"
                    id="githubAccessToken"
                    placeholder="Github Access Token"
                  />
                </div>
              </div>

              <div id="file-upload-div">
                <label class="fieldlabels"
                  >Upload Your Smart Contract Src Code (Zip file):
                </label>
                <input
                  type="file"
                  id="smart-contract-file-chosen"
                  name="smart-contract-file-chosen"
                  accept="zip,application/octet-stream,application/zip,application/x-zip,application/x-zip-compressed"
                />
              </div>
            </div>
            <input
              type="button"
              name="next"
              id="upload_next_button"
              class="next action-button"
              value="Next"
            />
          </fieldset>

          <fieldset id="smart-contract-install-info-fieldset">
            <div class="form-card">
              <div class="row">
                <div class="col-7">
                  <h2 class="fs-title">Chaincode Information</h2>
                </div>
                <div class="col-5">
                  <h2 class="steps">Step 2 - 3</h2>
                </div>
              </div>
              <label class="fieldlabels"
                >Chaincode Name: (Do not use underscores(_))*</label
              >
              <input
                type="text"
                name="chaincodeName"
                id="chaincodeName"
                placeholder="Chaincode Name"
              />
              <label class="fieldlabels">Chaincode Version: *</label>
              <input
                type="text"
                name="chaincodeVersion"
                id="chaincodeVersion"
                value="1.0"
                placeholder="Chaincode Version"
              />

              <label class="fieldlabels">Chaincode Src Path: *</label>
              <input
                type="text"
                name="chaincodeVersion"
                id="chaincodeSrcPath"
                value="/root/CLI/chaincodes/"
                placeholder="Chaincode Src Path"
              />

              <div id="select-peer-div">
                <label class="fieldlabels">Select Peer:</label>
                <select
                  id="smart-contract-install-peer"
                  class="custom-select custom-select-lg mb-3"
                >
                  <option value="peer1">Peer1</option>
                  <option selected value="peer2">Peer2</option>
                </select>
              </div>

              <div id="select-channel-div">
                <label class="fieldlabels">Select Channel:</label>
                <select
                  id="smart-contract-install-channel"
                  class="custom-select custom-select-lg mb-3"
                >
                  <option selected value="appchannel">appchannel</option>
                  <option value="appchannel2">appchannel2</option>
                </select>
              </div>

              <div id="select-programming-ganguage-div">
                <label class="fieldlabels"
                  >Select Smart Contract Implementation Language</label
                >
                <select
                  id="smart-contract-language"
                  class="custom-select custom-select-lg mb-3"
                >
                  <option selected value="node">node</option>
                  <option value="golang">golang</option>
                </select>
              </div>
            </div>
            <input
              type="button"
              name="next"
              id="install_next_button"
              class="next action-button"
              value="Next"
            />
            <input
              type="button"
              name="previous"
              class="previous action-button-previous"
              value="Previous"
            />
          </fieldset>

          <fieldset id="smart-contract-instantiate-info-fieldset">
            <div class="form-card">
              <div class="row">
                <div class="col-7">
                  <h2 class="fs-title">Instantiate Chaincode</h2>
                </div>
                <div class="col-5">
                  <h2 class="steps">Step 3 - 3</h2>
                </div>
              </div>
              <label class="fieldlabels">Provide Instantiate Parameters</label>
              <input
                type="text"
                name="fname"
                id="instantiate_params"
                value='{"Args":["InitLedger"]}'
                placeholder="Instantiate Parameters"
              />
            </div>
            <input
              type="button"
              name="next"
              id="instantiate_next_button"
              class="next action-button"
              value="Next"
            />
            <input
              type="button"
              name="previous"
              class="previous action-button-previous"
              value="Previous"
            />
          </fieldset>
          <fieldset>
            <div class="form-card">
              <div class="row">
                <div class="col-7">
                  <h2 class="fs-title">Finish:</h2>
                </div>
                <div class="col-5">
                  <h2 class="steps">Step 4 - 4</h2>
                </div>
              </div>
              <br /><br />
              <h2 class="purple-text text-center">
                <strong>SUCCESS !</strong>
              </h2>
              <br />
              <div class="row justify-content-center">
                <div class="col-3">
                  <img
                    src="https://i.imgur.com/GwStPmg.png"
                    class="fit-image"
                  />
                </div>
              </div>
              <br /><br />
              <div class="row justify-content-center">
                <div class="col-7 text-center">
                  <h5 class="purple-text text-center">
                    You Have Successfully Installed your smart contract
                  </h5>
                </div>
              </div>
            </div>
          </fieldset>
        </form>
      </div>
      <div class="card-footer text-muted">
        Install chaincode
      </div>
    </div>
  </div>
</div>

<script type="text/javascript" src="js/send_ajax_request.js"></script>

<script type="text/javascript">
  $("#github-repo-selector-div").show();
  $("#file-upload-div").hide();
  $('input:checkbox[name="fileUploadTypeSelection"]').change(function () {
    if ($(this).val() == "github") {
      //alert("github");
      $("#github-repo-selector-div").show();
      $("#file-upload-div").hide();
    } else {
      //alert("fileupload")
      $("#github-repo-selector-div").hide();
      $("#file-upload-div").show();
    }
  });
</script>

<script type="text/javascript">
  $("#github-private-repo-auth-credential-info-div").hide();
  $('input:radio[name="githubRepoType"]').change(function () {
    if ($(this).val() == "private") {
      $("#github-private-repo-auth-credential-info-div").show();
    } else {
      $("#github-private-repo-auth-credential-info-div").hide();
    }
  });
</script>

<script>
  // Add the following code if you want the name of the file appear on select
  $(".custom-file-input").on("change", function () {
    var fileName = $(this).val().split("\\").pop();
    $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
  });
</script>

<script>
  var current_fs, next_fs, previous_fs; //fieldsets
  var opacity;
  var current = 1;
  var steps = $("fieldset").length;

  setProgressBar(current);

  function validURL(str) {
    var pattern = new RegExp(
      "^(https?:\\/\\/)?" + // protocol
      "((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|" + // domain name
      "((\\d{1,3}\\.){3}\\d{1,3}))" + // OR ip (v4) address
      "(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*" + // port and path
      "(\\?[;&a-z\\d%_.~+=-]*)?" + // query string
        "(\\#[-a-z\\d_]*)?$",
      "i"
    ); // fragment locator
    return !!pattern.test(str);
  }

  $("#upload_next_button").click(function () {
    alert("hi");
    var fileUploadType = $(
      'input[name="fileUploadTypeSelection"]:checked'
    ).val();
    if (fileUploadType === "github") {
      var githubRepoType = $('input[name="githubRepoType"]:checked').val();
      // send ajax request to git clone
      var githubUrl = $("#githubUrl").val();
      var githubUrlRename = $("#githubUrlRename").val();
      var githubAccessToken = $("#githubAccessToken").val();
      var githubUrlBranch = $("#githubUrlBranch").val();

      var githubUrlJsondata = {
        githubUrlPath: githubUrl,
        githubUrlRenamePath: githubUrlRename,
        githubRepoType: githubRepoType,
        githubAccessToken: githubAccessToken,
        githubUrlBranch: githubUrlBranch,
      };
      //alert(githubUrl);
      isvalidUrl = validURL(githubUrl);
      //alert(isvalidUrl);
      if (isvalidUrl) {
        // send ajax request to git clone
        $("#overlay").show();
        //document.getElementById("ad_loader").style.display = "block";
        $.ajax({
          type: "POST",
          url: "/upload_smart_contract_git_clone",
          async: true,
          dataType: "json",
          data: githubUrlJsondata,
          complete: function (data) {
            $("#overlay").hide();
            var json = JSON.parse(
              data.responseText.replace(/\bNaN\b/g, "null")
            );
            var shell_exec_status = json["data"];
            if (shell_exec_status["Exit_Code"] == 0) {
              //swal.fire('Chaincode Uploaded successfully');
              Swal.fire("Chaincode Uploaded successfully").then(function () {
                increase_progress_bar("#upload_next_button");
              });
            } else if (shell_exec_status["Exit_Code"] == 128) {
              swal.fire(
                "Chaincode Upload Failed - " +
                  shell_exec_status["Error"] +
                  "Solution : Delete old file (or) rename the repository"
              );
            } else {
              swal.fire(
                "Chaincode Upload Failed - " + shell_exec_status["Error"]
              );
            }
          },
        });
      } else {
        swal.fire("Please Enter a proper Github Url");
      }
    } else {
      // send ajax request to file upload
    }
  });

  $("#install_next_button").click(function () {
    var chaincodeName = $("#chaincodeName").val();
    var chaincodeVersion = $("#chaincodeVersion").val();
    var chaincodeSrcPath = $("#chaincodeSrcPath").val();
    var peer = document.getElementById("smart-contract-install-peer").value;
    var channel = document.getElementById("smart-contract-install-channel")
      .value;
    var language = document.getElementById("smart-contract-language").value;

    var ajaxData = {
      chaincodeName: chaincodeName,
      chaincodeVersion: chaincodeVersion,
      chaincodeSrcPath: chaincodeSrcPath,
      peer: peer,
      channel: channel,
      language: language,
    };

    console.log(ajaxData);
    $("#overlay").show();
    $.ajax({
      type: "POST",
      url: "/install_smart_contract",
      async: true,
      dataType: "json",
      data: ajaxData,
      complete: function (data) {
        $("#overlay").hide();
        var json = JSON.parse(data.responseText.replace(/\bNaN\b/g, "null"));
        var shell_exec_status = json["data"];
        if (shell_exec_status["Exit_Code"] == 0) {
          //swal.fire('Chaincode Uploaded successfully');
          Swal.fire("Chaincode installed successfully").then(function () {
            increase_progress_bar("#install_next_button");
          });
        } else {
          swal.fire("Chaincode Install Failed - " + shell_exec_status["Error"]);
        }
      },
    });
  });

  $("#instantiate_next_button").click(function () {
    var chaincodeName = $("#chaincodeName").val();
    var chaincodeVersion = $("#chaincodeVersion").val();
    var chaincodeSrcPath = $("#chaincodeSrcPath").val();
    var chaincodeInstantiateParams = $("#instantiate_params").val();
    var peer = document.getElementById("smart-contract-install-peer").value;
    var channel = document.getElementById("smart-contract-install-channel")
      .value;
    var language = document.getElementById("smart-contract-language").value;

    var ajaxData = {
      chaincodeName: chaincodeName,
      chaincodeVersion: chaincodeVersion,
      chaincodeSrcPath: chaincodeSrcPath,
      chaincodeInstantiateParams: chaincodeInstantiateParams,
      peer: peer,
      channel: channel,
      language: language,
    };

    console.log(ajaxData);
    $("#overlay").show();
    $.ajax({
      type: "POST",
      url: "/instantiate_smart_contract",
      async: true,
      dataType: "json",
      data: ajaxData,
      complete: function (data) {
        $("#overlay").hide();
        var json = JSON.parse(data.responseText.replace(/\bNaN\b/g, "null"));
        var shell_exec_status = json["data"];
        if (shell_exec_status["Exit_Code"] == 0) {
          //swal.fire('Chaincode Uploaded successfully');
          Swal.fire("Chaincode instantiatied successfully").then(function () {
            increase_progress_bar("#instantiate_next_button");
          });
        } else {
          swal.fire(
            "Chaincode instantiation Failed - " + shell_exec_status["Error"]
          );
        }
      },
    });
  });

  function increase_progress_bar(sectionid) {
    //alert(sectionid);
    console.log("sectionid");
    console.log(sectionid);
    current_fs = $(sectionid).parent();
    next_fs = $(sectionid).parent().next();

    console.log("current_fs");
    console.log(current_fs);
    console.log("next_fs");
    console.log(next_fs);

    var next_fs_index = $("fieldset").index(next_fs);
    alert(next_fs_index);

    //Add Class Active
    $("#progressbar li").eq($("fieldset").index(next_fs)).addClass("active");

    //show the next fieldset
    next_fs.show();
    //hide the current fieldset with style
    current_fs.animate(
      { opacity: 0 },
      {
        step: function (now) {
          // for making fielset appear animation
          opacity = 1 - now;

          current_fs.css({
            display: "none",
            position: "relative",
          });
          next_fs.css({ opacity: opacity });
        },
        duration: 500,
      }
    );
    setProgressBar(++current);
  }

  $(".previous").click(function () {
    current_fs = $(this).parent();
    previous_fs = $(this).parent().prev();
    console.log("current_fs");
    console.log($("fieldset").index(current_fs));
    console.log("next_fs");
    console.log($("fieldset").index(next_fs));

    //Remove class active
    $("#progressbar li")
      .eq($("fieldset").index(current_fs))
      .removeClass("active");

    //show the previous fieldset
    previous_fs.show();

    //hide the current fieldset with style
    current_fs.animate(
      { opacity: 0 },
      {
        step: function (now) {
          // for making fielset appear animation
          opacity = 1 - now;

          current_fs.css({
            display: "none",
            position: "relative",
          });
          previous_fs.css({ opacity: opacity });
        },
        duration: 500,
      }
    );
    setProgressBar(--current);
  });

  function setProgressBar(curStep) {
    var percent = parseFloat(100 / steps) * curStep;
    percent = percent.toFixed();
    $(".progress-bar").css("width", percent + "%");
  }

  $(".submit").click(function () {
    return false;
  });
</script>
