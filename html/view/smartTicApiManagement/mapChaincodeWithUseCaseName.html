<div class="container mb-4">
  <h1 class="my-4 p-3 text-white bg-secondary text-center">
    <i class="fa fa-eye" aria-hidden="true"></i> Mapped Chaincodes
    <span id="chainCodeCount"></span>
  </h1>
  <form
    id="filterInstalledChainCodeForm"
    action="/getInstalledOrInstantiatedChainCodeList"
    enctype="multipart/form-data"
    method="POST"
  >
    <div class="row">
      <div
        class="mx-auto mb-3 col-12 col-sm-12 col-md-7 col-lg-6 col-xl-2 px-4 mt-3"
      >
        <!-- <label for="peerSelection" class="form-label text-center">Select Peer</label> -->
        <select
          name="peerSelection"
          id="peerSelection"
          class="form-select chainCodeListForm-select"
          aria-label="Select a Peer :"
        >
          <option value="peer1">Peer1</option>
          <option selected value="peer2">Peer2</option>
        </select>
        <!-- <small class="form-text text-muted my-1">Select the peer</small> -->
      </div>
      <div
        class="mx-auto mb-3 col-12 col-sm-12 col-md-7 col-lg-6 col-xl-2 px-4 mt-3"
      >
        <!-- <label for="typeSelection" class="form-label text-center">Select Type</label> -->
        <select
          name="typeSelection"
          id="typeSelection"
          class="form-select chainCodeListForm-select"
          aria-label="Select a Type :"
        >
          <option selected value="installed">Installed</option>
          <option value="instantiated">Instantiated</option>
        </select>
        <!-- <small class="form-text text-muted my-1">(installed/instantiated)</small> -->
      </div>
      <div
        class="mx-auto mb-3 col-12 col-sm-12 col-md-7 col-lg-6 col-xl-2 px-4 mt-3"
      >
        <!-- <label for="chainCodeSelectInput" class="form-label text-center">Select Peer</label> -->
        <select
          name="chainCodeSelectInput"
          id="chainCodeSelectInput"
          name="chainCodeSelectInput"
          class="form-select"
          aria-label="Select a Chaincode :"
        >
          <option selected value="Select a Chaincode"
            >Select a Chaincode</option
          >
        </select>
        <small class="form-text text-muted my-1"
          ><div class="text-center chainCodeListFetchingSpinner">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div></small
        >
      </div>
      <div
        class="mx-auto mb-3 col-12 col-sm-12 col-md-7 col-lg-6 col-xl-2 px-4 mt-3"
      >
        <!-- <label for="useCaseSelectInput" class="form-label text-center">Select Type</label> -->
        <select
          name="useCaseSelectInput"
          id="useCaseSelectInput"
          class="form-select"
          aria-label="Select a Type :"
        >
          <option selected value="Select a Use Case">Select a Use Case</option>
        </select>
        <small class="form-text text-muted my-1"
          ><div class="text-center useCaseListTableContentFetchingSpinner">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div></small
        >
      </div>
      <div
        class="mx-auto mb-3 col-12 col-sm-12 col-md-7 col-lg-6 col-xl-2 px-4 mt-3 float-end"
      >
        <button
          class="btn btn-outline-secondary mx-auto"
          type="button"
          id="mapButton"
        >
          <i class="fa fa-angle-double-right" aria-hidden="true"></i> Map
        </button>
      </div>
      <div
        class="mx-auto mb-3 col-12 col-sm-12 col-md-7 col-lg-6 col-xl-2 px-4 mt-3 float-end"
      >
        <button
          class="btn btn-outline-secondary float-end"
          type="button"
          id="refreshButton"
        >
          <i class="fa fa-refresh" aria-hidden="true"></i> Refresh
        </button>
      </div>
    </div>
  </form>
  <div class="text-center chainCodeListTableContentFetchingSpinner">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  <div class="table-responsive">
    <table
      id="chainCodeListDataTable"
      class="table table-striped table-hover dt-responsive display nowrap text-center"
    ></table>
  </div>
</div>

<script>
  function parseCommandLineOutputOfChainCodeObjectList(string) {
    var properties = string.split(", ");
    var obj = {};
    properties.forEach(function (property) {
      var tup = property.split(": ");
      obj[tup[0]] = tup[1];
    });
    return obj;
  }
  function parseChainCodeListCommandOutput(output) {
    let parsedResponse = output.split(/\r?\n/);
    //console.log(parsedResponse);
    let finalChainCodeDetailsArray = [];
    for (chaincode of parsedResponse) {
      let parsedChaincodeDetails = parseCommandLineOutputOfChainCodeObjectList(
        chaincode
      );
      if ("Name" in parsedChaincodeDetails) {
        finalChainCodeDetailsArray.push(Object.values(parsedChaincodeDetails));
      }
    }
    return finalChainCodeDetailsArray;
  }
  function sendAjaxReqToGetListOfInstalledChaincodes() {
    $(".chainCodeListFetchingSpinner").show();
    $.ajax({
      type: "POST",
      url: "/getInstalledOrInstantiatedChainCodeList",
      data: new FormData(
        document.getElementById("filterInstalledChainCodeForm")
      ),
      processData: false,
      contentType: false,
      async: true,
      complete: function (data) {
        var json = JSON.parse(data.responseText.replace(/\bNaN\b/g, "null"));
        console.log(json);
        $(".chainCodeListFetchingSpinner").hide();
        if (json["status"] === "success") {
          const dataTableData = parseChainCodeListCommandOutput(
            json["data"]["Output"]
          );
          console.log("dataTableData");
          console.log(dataTableData);
          $("#chainCodeSelectInput").empty();
          $("#chainCodeSelectInput").append(
            $("<option selected class='breakUrlLink'>")
              .attr("value", "Select a Chaincode")
              .text("Select a Chaincode")
          );
          $.each(dataTableData, function (i, item) {
            console.log(item, i);
            $("#chainCodeSelectInput").append(
              $("<option class='breakUrlLink'>")
                .attr("value", item["Name"])
                .text(item["Name"])
            );
          });
        } else {
          swal.fire({
            title: "Installed Chaincode List Retrieval",
            text: json["status"],
            icon: "error",
            confirmButtonText: '<i class="fa fa-thumbs-down"></i> Failed',
          });
        }
      },
    });
  }
</script>
<script>
  function sendAjaxReqToGetListOfMappedChaincodesAndUseCases() {
    $("#chainCodeListDataTable").empty();
    $(".chainCodeListTableContentFetchingSpinner").show();
    $.ajax({
      type: "POST",
      url: "/getMappedChainCodeListWithUseCase",
      data: new FormData(
        document.getElementById("filterInstalledChainCodeForm")
      ),
      processData: false,
      contentType: false,
      async: true,
      complete: function (data) {
        var json = JSON.parse(data.responseText.replace(/\bNaN\b/g, "null"));
        console.log(json);

        if (json["status"] === "success") {
          //const dataTableData = json["data"]["Output"];

          $("#chainCodeListDataTable").DataTable({
            destroy: true,
            data: json["data"],
            //pageResize: true,
            responsive: true,
            pageLength: 4,
            bAutoWidth: false,
            columns: [
              { title: "Chaincode Name", data: "ChaincodeName" },
              { title: "Use Case Name", data: "UseCaseName" },
              { title: "Delete", data: "deleteMapping" },
            ],
            initComplete: function (settings, jsonData) {
              $(".chainCodeListTableContentFetchingSpinner").hide();
              $("#chainCodeCount").text(" - " + String(json["data"].length));
            },
          });
        } else {
          swal.fire({
            title: "Installed Chaincode List Retrieval",
            text: json["status"],
            icon: "error",
            confirmButtonText: '<i class="fa fa-thumbs-down"></i> Failed',
          });
        }
      },
    });
  }
</script>
<script>
  function sendAjaxReqToGetListOfCreatedUseCases() {
    $(".useCaseListTableContentFetchingSpinner").show();
    $.ajax({
      type: "POST",
      url: "/getUseCasesListDataFromSmartApi",
      // data: new FormData(
      //   document.getElementById("viewCreatedUseCaseListDataForm")
      // ),
      processData: false,
      contentType: false,
      async: true,
      // fnRowCallback: function (nRow, aData, iDisplayIndex) {
      //   $("td:first", nRow).html(iDisplayIndex + 1);
      //   return nRow;
      // },
      complete: function (data) {
        var json = JSON.parse(data.responseText.replace(/\bNaN\b/g, "null"));
        console.log(json);

        if (json["status"] === "success") {
          $("#useCaseSelectInput").empty();
          $("#useCaseSelectInput").append(
            $("<option selected class='breakUrlLink'>")
              .attr("value", "Select a Use Case")
              .text("Select a Use Case")
          );
          $.each(json["data"], function (i, item) {
            $("#useCaseSelectInput").append(
              $("<option class='breakUrlLink'>")
                .attr("value", item["name"])
                .text(item["name"])
            );
          });
          $(".useCaseListTableContentFetchingSpinner").hide();
        } else {
          swal.fire({
            title: "Use Case List Retrieval",
            text: json["status"],
            icon: "error",
            confirmButtonText: '<i class="fa fa-thumbs-down"></i> Failed',
          });
        }
      },
    });
  }
</script>

<script>
  function sendAjaxReqToMapChaincodeNameWithUseCaseName() {
    $("#chainCodeListDataTable").empty();
    $(".chainCodeListTableContentFetchingSpinner").show();
    $.ajax({
      type: "POST",
      url: "/mapChainCodeWithUseCase",
      data: new FormData(
        document.getElementById("filterInstalledChainCodeForm")
      ),
      processData: false,
      contentType: false,
      async: true,
      complete: function (data) {
        var json = JSON.parse(data.responseText.replace(/\bNaN\b/g, "null"));
        console.log(json);

        if (json["status"] === "success") {
          //const dataTableData = json["data"]["Output"];

          $("#chainCodeListDataTable").DataTable({
            destroy: true,
            data: json["data"],
            //pageResize: true,
            responsive: true,
            pageLength: 4,
            bAutoWidth: false,
            columns: [
              { title: "Chaincode Name", data: "ChaincodeName" },
              { title: "Use Case Name", data: "UseCaseName" },
              { title: "Delete", data: "deleteMapping" },
            ],
            initComplete: function (settings, jsonData) {
              $(".chainCodeListTableContentFetchingSpinner").hide();
              $("#chainCodeCount").text(" - " + String(json["data"].length));
            },
          });
        } else {
          swal.fire({
            title: "Installed Chaincode List Retrieval",
            text: json["status"],
            icon: "error",
            confirmButtonText: '<i class="fa fa-thumbs-down"></i> Failed',
          });
        }
      },
    });
  }
</script>

<script>
  function deleteSelectedChainCodeMapping(
    deleteFileButtonObject,
    chainCodeName
  ) {
    // show the loading spinner span tag for selected the button
    $(deleteFileButtonObject).children(".chainCodeMapDeleteSpinner").show();

    var request_json = {
      chainCodeName: chainCodeName,
    };

    $.ajax({
      type: "POST",
      url: "/deleteSelectedChainCodeMApping",
      async: true,
      dataType: "json",
      data: request_json,
      complete: function (data) {
        // hide the loading spinner span tag for selected the button
        $(deleteFileButtonObject).children(".chainCodeMapDeleteSpinner").hide();
        //console.log(JSON.parse(data.responseText));
        //var json = JSON.parse(data.responseText.replace(/\bNaN\b/g, "null"));
        var json = JSON.parse(data.responseText.replace(/\bNaN\b/g, "null"));
        console.log(json);
        if (json["status"] === "success") {
          swal
            .fire({
              heightAuto: false,
              title: "Delete Chaincode File Status",
              text:
                json["status"] +
                '! Chaincode File "' +
                chainCodeName +
                '" was deleted successfully !',
              icon: "success",
              confirmButtonText:
                '<i class="fa fa-thumbs-up"></i> Chaincode File Deleted Successfully!',
            })
            .then((result) => {
              /* Read more about isConfirmed, isDenied below */
              if (result.isConfirmed) {
                sendAjaxReqToGetListOfMappedChaincodesAndUseCases();
              }
            });
        } else {
          swal.fire({
            heightAuto: false,
            title: "Delete Chaincode File Status",
            text: json["status"],
            icon: "error",
            confirmButtonText:
              '<i class="fa fa-thumbs-down"></i> Chaincode File Deletion Failed',
          });
        }
      },
    });
  }
</script>
<script>
  function processRequestToDeleteSelectedChainCodeMapping(
    deleteFileButtonObject
  ) {
    var chainCodeName = deleteFileButtonObject.getAttribute("data-link");
    swal
      .fire({
        heightAuto: false,
        title: "Confirm Delete ?",
        // width: "min-content",
        showCloseButton: true,
        text:
          "Are you sure want to delete the Mapping '" +
          chainCodeName +
          "' ? The Mapping will be deleted. This operation is irreversible !",
        icon: "info",
        showCancelButton: true,
        confirmButtonText: '<i class="fa fa-trash"></i> Confirm Delete !',
        cancelButtonText: '<i class="fa fa-close"></i> Cancel',
      })
      .then((result) => {
        /* Read more about isConfirmed, isDenied below */
        if (result.isConfirmed) {
          deleteSelectedChainCodeMapping(deleteFileButtonObject, chainCodeName);
        }
      });
  }
</script>

<script>
  $(".chainCodeListForm-select").on("change", function () {
    //alert(this.value);
    sendAjaxReqToGetListOfInstalledChaincodes();
  });
  $("#refreshButton").click(function () {
    sendAjaxReqToGetListOfMappedChaincodesAndUseCases();
  });

  $("#mapButton").click(function () {
    sendAjaxReqToMapChaincodeNameWithUseCaseName();
  });
</script>

<script>
  $(document).ready(function () {
    sendAjaxReqToGetListOfInstalledChaincodes();
    sendAjaxReqToGetListOfMappedChaincodesAndUseCases();
    sendAjaxReqToGetListOfCreatedUseCases();
  });
</script>
